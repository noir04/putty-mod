name: Build Custom PuTTY

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Clone PuTTY Repository
      run: git clone https://git.tartarus.org/simon/putty.git .

    - name: Smart Patch UI
      shell: python
      run: |
        import re
        import sys
        import os
        import glob

        # ---------------------------------------------------------
        # 1. LOCATE THE CORRECT FILE
        # ---------------------------------------------------------
        # Search all .rc and .rc2 files in the windows/ directory
        search_pattern = "windows/*.rc*"
        target_file = None
        
        candidates = glob.glob("windows/*.rc") + glob.glob("windows/*.rc2")
        
        print(f"Scanning files: {candidates}")

        for filepath in candidates:
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                if "IDD_MAINBOX" in f.read():
                    target_file = filepath
                    break
        
        if not target_file:
            print("CRITICAL ERROR: Could not find any file containing 'IDD_MAINBOX'.")
            sys.exit(1)
            
        print(f"FOUND TARGET FILE: {target_file}")

        # ---------------------------------------------------------
        # 2. READ & CONFIG
        # ---------------------------------------------------------
        with open(target_file, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()

        ADD_HEIGHT = 200 # How many pixels to add
        
        # ---------------------------------------------------------
        # 3. RESIZE MAIN WINDOW (IDD_MAINBOX)
        # ---------------------------------------------------------
        # Pattern matches: IDD_MAINBOX ... 0, 0, 300, 218
        # We look for the last number in that sequence
        main_box_pattern = r'(IDD_MAINBOX\s+[^\n]+0,\s*0,\s*\d+,\s*)(\d+)'
        match = re.search(main_box_pattern, content)
        
        if not match:
            print("ERROR: Found file but regex failed to match IDD_MAINBOX dimensions.")
            sys.exit(1)

        original_main_height = int(match.group(2))
        new_main_height = original_main_height + ADD_HEIGHT
        
        content = content.replace(match.group(0), f"{match.group(1)}{new_main_height}")
        print(f"Resized Main Window: {original_main_height} -> {new_main_height}")

        # ---------------------------------------------------------
        # 4. RESIZE SESSION LIST
        # ---------------------------------------------------------
        # Usually width 120. Pattern: LISTBOX id, x, y, 120, height
        listbox_pattern = r'(LISTBOX\s+[^,]+,\s*\d+,\s*\d+,\s*120\s*,\s*)(\d+)'
        
        def resize_listbox(m):
            h = int(m.group(2))
            if h > 50: # Sanity check
                return f"{m.group(1)}{h + ADD_HEIGHT}"
            return m.group(0)

        content, count = re.subn(listbox_pattern, resize_listbox, content)
        print(f"Resized {count} listboxes.")

        # ---------------------------------------------------------
        # 5. MOVE BOTTOM BUTTONS
        # ---------------------------------------------------------
        # Move buttons that are currently near the bottom of the original window
        bottom_threshold = original_main_height - 35 

        button_pattern = r'((?:PUSHBUTTON|DEFPUSHBUTTON)\s+"[^"]+",\s*[^,]+,\s*\d+,\s*)(\d+)(,.*)'

        def move_button(m):
            prefix = m.group(1)
            y = int(m.group(2))
            suffix = m.group(3)
            
            if y > bottom_threshold:
                new_y = y + ADD_HEIGHT
                return f"{prefix}{new_y}{suffix}"
            return m.group(0)

        content, b_count = re.subn(button_pattern, move_button, content)
        print(f"Moved {b_count} buttons down.")

        # ---------------------------------------------------------
        # 6. SAVE
        # ---------------------------------------------------------
        with open(target_file, 'w', encoding='utf-8') as f:
            f.write(content)
            
        print("SUCCESS: Patched UI resources.")

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload PuTTY Artifact
      uses: actions/upload-artifact@v4
      with:
        name: putty-custom-windows
        path: build/Release/putty.exe
