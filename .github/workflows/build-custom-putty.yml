name: Build Custom PuTTY

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Clone PuTTY Repository
      # We clone the official repository
      run: git clone https://git.tartarus.org/simon/putty.git .

    - name: Modify Session List Size
      shell: powershell
      run: |
        $rcFile = "windows/putty.rc"
        
        if (-Not (Test-Path $rcFile)) {
            Write-Error "Could not find $rcFile. Source structure may have changed."
            exit 1
        }

        $content = Get-Content $rcFile -Raw

        # 1. Increase Dialog Height (IDD_MAINBOX)
        # Finds "218" (standard height) in the main dialog definition and changes it to "350"
        if ($content -match '(IDD_MAINBOX\s+DIALOG[^0-9]+0,\s*0,\s*300,\s*)218') {
            $content = $content -replace '(IDD_MAINBOX\s+DIALOG[^0-9]+0,\s*0,\s*300,\s*)218', '${1}350'
            Write-Host "Success: Patched Dialog Height."
        } else {
            Write-Warning "Could not find IDD_MAINBOX dimensions to patch. The source code might have changed."
        }

        # 2. Increase ListBox Height
        # Finds "110" (standard list height) specifically inside the listbox definition and changes to "240"
        # We look for the standard width (120) followed by height (110)
        if ($content -match '(\s+120,\s*)110') {
            $content = $content -replace '(\s+120,\s*)110', '${1}240'
            Write-Host "Success: Patched ListBox Height."
        } else {
             Write-Warning "Could not find ListBox dimensions to patch."
        }

        Set-Content -Path $rcFile -Value $content

    - name: Configure CMake
      # We use the system installed CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload PuTTY Artifact
      uses: actions/upload-artifact@v4
      with:
        name: putty-custom-windows
        path: build/Release/putty.exe
