name: Build Custom Version Of PuTTY

on:
  workflow_dispatch:

jobs:
  build-putty:
    runs-on: windows-latest
    
    steps:
      - name: Get latest PuTTY release
        id: get_release
        run: |
          # Fetch tags and get the latest release tag
          LATEST_TAG=$(git ls-remote --tags --refs https://git.tartarus.org/simon/putty.git | grep -o 'refs/tags/[0-9].*' | sort -V | tail -n1 | sed 's|refs/tags/||')
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          git clone --depth 1 --branch $LATEST_TAG https://git.tartarus.org/simon/putty.git .
        shell: bash
      
      - name: Set up build environment
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive" -y
        shell: powershell
      
      - name: Increase session list visible height
        run: |
          Write-Host "=== Modifying PuTTY session list height ==="
          
          # Change 1: Increase session listbox height in config.c
          if (Test-Path "config.c") {
            Write-Host "Modifying config.c..."
            $content = Get-Content "config.c" -Raw
            $content = $content -replace 'ssd->listbox->listbox\.height = 7;', 'ssd->listbox->listbox.height = 37;'
            Set-Content "config.c" $content
            Write-Host "  Changed listbox height from 7 to 37"
          } else {
            Write-Host "ERROR: config.c not found!"
          }
          
          # Change 2: Increase dialog height in windows/dialog.c
          if (Test-Path "windows\dialog.c") {
            Write-Host "Modifying windows/dialog.c..."
            $content = Get-Content "windows\dialog.c" -Raw
            $content = $content -replace 'pds_create_controls\(pds, TREE_BASE, IDCX_STDBASE, 3, 3, 235, ""\);', 'pds_create_controls(pds, TREE_BASE, IDCX_STDBASE, 3, 3, 470, "");'
            Set-Content "windows\dialog.c" $content
            Write-Host "  Changed dialog height from 235 to 470"
          } else {
            Write-Host "ERROR: windows/dialog.c not found!"
          }
          
          # Change 3: Increase main dialog box size in windows/putty-common.rc2
          if (Test-Path "windows\putty-common.rc2") {
            Write-Host "Modifying windows/putty-common.rc2..."
            $content = Get-Content "windows\putty-common.rc2" -Raw
            $content = $content -replace 'IDD_MAINBOX DIALOG DISCARDABLE 0, 0, 300, 252', 'IDD_MAINBOX DIALOG DISCARDABLE 0, 0, 350, 492'
            Set-Content "windows\putty-common.rc2" $content
            Write-Host "  Changed main dialog from 300x252 to 350x492"
          } else {
            Write-Host "ERROR: windows/putty-common.rc2 not found!"
          }
          
          Write-Host ""
          Write-Host "=== All modifications complete ==="
        shell: powershell
      
      - name: Configure build with CMake
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
        shell: cmd
      
      - name: Build PuTTY
        run: |
          cd build
          cmake --build . --config Release
        shell: cmd
      
      - name: Collect artifacts
        run: |
          mkdir output
          Copy-Item "build\Release\putty.exe" "output\" -ErrorAction Stop
        shell: powershell
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: putty-modified-v${{ steps.get_release.outputs.tag }}-windows
          path: output/
          retention-days: 30
