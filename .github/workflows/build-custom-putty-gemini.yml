name: Build Custom PuTTY - Gemini

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Clone PuTTY Repository
      run: |
        git clone https://git.tartarus.org/simon/putty.git .
        # Fetch tags and checkout the latest version (e.g., 0.82)
        git fetch --tags
        # Get latest tag that looks like a version (ignoring pre-releases if any)
        $tag = git tag --sort=-v:refname | Select-Object -First 1
        Write-Host "Checking out version: $tag"
        git checkout $tag

    - name: Patch UI (Python)
      shell: python
      run: |
        import re
        import sys
        import glob

        # --- CONFIGURATION ---
        ADD_HEIGHT = 200  # How much taller to make the list
        # ---------------------

        # 1. FIND THE RESOURCE FILE
        # It's usually windows/putty-common.rc2 or windows/putty.rc depending on version
        candidates = glob.glob("windows/*.rc") + glob.glob("windows/*.rc2")
        target_file = None

        print("Scanning for IDD_MAINBOX...")
        for filepath in candidates:
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                if "IDD_MAINBOX" in f.read():
                    target_file = filepath
                    break
        
        if not target_file:
            print("CRITICAL: Could not find file containing IDD_MAINBOX")
            sys.exit(1)
            
        print(f"Patching file: {target_file}")

        with open(target_file, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()

        # 2. RESIZE MAIN WINDOW
        # Look for: IDD_MAINBOX ... 0, 0, 300, 218
        main_box_pattern = r'(IDD_MAINBOX\s+[^\n]+0,\s*0,\s*\d+,\s*)(\d+)'
        match = re.search(main_box_pattern, content)
        if match:
            h = int(match.group(2))
            # Only resize if it looks like the default size (approx 200-250)
            original_main_height = h
            new_main_height = h + ADD_HEIGHT
            content = content.replace(match.group(0), f"{match.group(1)}{new_main_height}")
            print(f"Main Window: {h} -> {new_main_height}")
        else:
            print("ERROR: Could not find Main Window definition")
            sys.exit(1)

        # 3. RESIZE GROUP BOX ("Load, save or delete a stored session")
        # This box surrounds the list. If we don't resize this, it looks weird.
        # Pattern: GROUPBOX "text", id, x, y, w, h
        group_pattern = r'(GROUPBOX\s+"Load, save or delete[^"]+",\s*\d+,\s*\d+,\s*\d+,\s*\d+,\s*)(\d+)'
        match = re.search(group_pattern, content)
        if match:
            h = int(match.group(2))
            content = content.replace(match.group(0), f"{match.group(1)}{h + ADD_HEIGHT}")
            print(f"Group Box: {h} -> {h + ADD_HEIGHT}")
        else:
            print("WARNING: Could not find Session GroupBox.")

        # 4. RESIZE SESSION LISTBOX
        # We look for a LISTBOX that has a width of approx 120 and height approx 100-115
        list_pattern = r'(LISTBOX\s+[^,]+,\s*\d+,\s*\d+,\s*120\s*,\s*)(\d+)'
        
        def resize_list(m):
            h = int(m.group(2))
            # Standard session list is usually around 110 height
            if 90 < h < 140:
                print(f"Session List: {h} -> {h + ADD_HEIGHT}")
                return f"{m.group(1)}{h + ADD_HEIGHT}"
            return m.group(0)

        content, count = re.subn(list_pattern, resize_list, content)
        if count == 0:
            print("WARNING: Did not find a standard 120-width ListBox. Trying looser search...")
            # Fallback: Find generic listbox inside the main box area? 
            # Often ID is 1004 or IDC_SESSIONS. Let's try searching for the specific ID 1004.
            # LISTBOX 1004, ...
            content = re.sub(r'(LISTBOX\s+1004,\s*\d+,\s*\d+,\s*\d+\s*,\s*)(\d+)', 
                             lambda m: f"{m.group(1)}{int(m.group(2)) + ADD_HEIGHT}", content)

        # 5. MOVE BOTTOM BUTTONS
        # Move Open/Cancel/Help buttons down
        bottom_threshold = original_main_height - 35
        
        # Regex for buttons (PUSHBUTTON or DEFPUSHBUTTON)
        btn_pattern = r'((?:PUSHBUTTON|DEFPUSHBUTTON)\s+"[^"]+",\s*[^,]+,\s*\d+,\s*)(\d+)(,.*)'

        def move_btn(m):
            prefix = m.group(1)
            y = int(m.group(2))
            suffix = m.group(3)
            if y > bottom_threshold:
                return f"{prefix}{y + ADD_HEIGHT}{suffix}"
            return m.group(0)

        content = re.sub(btn_pattern, move_btn, content)
        print("Moved bottom buttons.")

        # WRITE CHANGES
        with open(target_file, 'w', encoding='utf-8') as f:
            f.write(content)

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload PuTTY Artifact
      uses: actions/upload-artifact@v4
      with:
        name: putty-custom-windows
        path: build/Release/putty.exe
