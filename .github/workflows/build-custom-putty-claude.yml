name: Build Custom PuTTY - Claude

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 2am UTC
    - cron: '0 2 * * 0'

jobs:
  build-putty:
    runs-on: windows-latest
    
    steps:
      - name: Get latest PuTTY release
        id: get_release
        run: |
          # Fetch tags and get the latest release tag
          git clone --depth 1 --branch $(git ls-remote --tags --refs https://git.tartarus.org/simon/putty.git | grep -o 'refs/tags/[0-9].*' | sort -V | tail -n1 | sed 's|refs/tags/||') https://git.tartarus.org/simon/putty.git .
        shell: bash
      
      - name: Set up build environment
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive" -y
        shell: powershell
      
      - name: Increase session list visible height
        run: |
          # Increase the visible height of the session list dropdown
          # The session list height is typically controlled in windows/dialog.c or windows/controls.c
          # Look for the listbox height parameter in the saved sessions control
          
          $files = Get-ChildItem -Recurse -Include *.c,*.h
          
          foreach ($file in $files) {
            $content = Get-Content $file.FullName -Raw
            
            # Look for session list box creation - typically has a height parameter
            # Common patterns: CreateWindow with "ListBox" or similar controls
            # The height is usually specified in dialog units or pixels
            
            # Pattern for dialog box height (commonly 3 or 4 dialog units, increase to 12-15)
            if ($content -match 'ctrl_listbox.*\bheight\s*,\s*(\d+)') {
              Write-Host "Found listbox height in $($file.FullName)"
              $content = $content -replace '(ctrl_listbox.*\bheight\s*,\s*)(\d+)', '${1}15'
              Set-Content $file.FullName $content
            }
            
            # Look for CTRL_LISTBOX definitions with height parameters
            if ($file.Name -eq "dialog.c" -or $file.Name -eq "config.c") {
              # Increase the height value in dialog unit specifications
              # Typical: height of 3 or 4, increase to 12-15 for more visible items
              $modified = $false
              
              # Pattern: numbers that look like dialog heights (small numbers 3-10)
              if ($content -match 'savedlist.*') {
                $content = $content -replace '(\bctrl_listbox\([^,]+,\s*[^,]+,\s*[^,]+,\s*[^,]+,\s*)([3-9])(\s*,)', '${1}15${3}'
                $modified = $true
              }
              
              if ($modified) {
                Set-Content $file.FullName $content
                Write-Host "Modified dialog height in $($file.FullName)"
              }
            }
          }
          
          # Specifically target windows/config.c where session panel is defined
          if (Test-Path "windows\config.c") {
            $configContent = Get-Content "windows\config.c" -Raw
            # The saved sessions listbox typically uses COMP_LISTBOX with a height of 3-4
            # Increase to 15 for better visibility
            $configContent = $configContent -replace '(savedlist[^\n]*ctrl_listbox[^\n]*,\s*)([3-9])(\s*,)', '${1}15${3}'
            $configContent = $configContent -replace '(COMP_LISTBOX[^\n]*savedlist[^\n]*,\s*)([3-9])(\s*\))', '${1}15${3}'
            Set-Content "windows\config.c" $configContent
            Write-Host "Modified session list height in windows/config.c"
          }
          
          Write-Host "Session list height modifications completed"
        shell: powershell
      
      - name: Configure build with CMake
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A Win32
        shell: cmd
      
      - name: Build PuTTY
        run: |
          cd build
          cmake --build . --config Release
        shell: cmd
      
      - name: Collect artifacts
        run: |
          mkdir output
          Copy-Item "build\Release\putty.exe" "output\" -ErrorAction Stop
        shell: powershell
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: putty-modified-windows
          path: output/
          retention-days: 30
      
      - name: Create release (optional)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: putty-modified-${{ github.run_number }}
          name: Modified PuTTY Build ${{ github.run_number }}
          body: |
            Modified PuTTY build with increased session list visible height.
            
            Built from latest PuTTY release.
            
            **Modifications:**
            - Increased session list dropdown height for better visibility (no scrolling needed for more sessions)
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
