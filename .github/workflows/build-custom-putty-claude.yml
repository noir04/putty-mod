name: Build Custom PuTTY - Claude

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 2am UTC
    - cron: '0 2 * * 0'

jobs:
  build-putty:
    runs-on: windows-latest
    
    steps:
      - name: Get latest PuTTY release
        id: get_release
        run: |
          # Fetch tags and get the latest release tag
          git clone --depth 1 --branch $(git ls-remote --tags --refs https://git.tartarus.org/simon/putty.git | grep -o 'refs/tags/[0-9].*' | sort -V | tail -n1 | sed 's|refs/tags/||') https://git.tartarus.org/simon/putty.git .
        shell: bash
      
      - name: Set up build environment
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive" -y
        shell: powershell
      
      - name: Increase session list visible height
        run: |
          Write-Host "=== Modifying PuTTY session list height ==="
          
          # Step 1: Find and modify the session listbox height in windows/config.c
          if (Test-Path "windows\config.c") {
            Write-Host "Processing windows/config.c..."
            $content = Get-Content "windows\config.c" -Raw
            $original = $content
            
            # The session list is typically created like:
            # ctrl_listbox(s, "Saved Sessions", 'e', ...., HEIGHT, ....)
            # Where HEIGHT is usually 3, 4, or 5 - we want to change it to 12
            
            # Replace pattern for ctrl_listbox with small height value
            $content = $content -replace '(ctrl_listbox\s*\([^)]*"Saved Sessions"[^)]*,\s*)([3-6])(\s*,)', '${1}12${3}'
            
            # Alternate pattern if the above doesn't match
            $content = $content -replace '(ctrl_listbox\s*\(\s*s\s*,[^,]*,[^,]*,[^,]*,[^,]*,\s*)([3-6])(\s*,)', '${1}12${3}'
            
            if ($content -ne $original) {
              Set-Content "windows\config.c" $content
              Write-Host "Success: Modified session listbox height in windows/config.c"
            } else {
              Write-Host "Warning: No changes made to windows/config.c - pattern may not match"
              Write-Host "Attempting broader search..."
              
              # Try to find any ctrl_listbox with a small height and increase it
              $lines = Get-Content "windows\config.c"
              for ($i = 0; $i -lt $lines.Count; $i++) {
                if ($lines[$i] -match 'ctrl_listbox' -and $lines[$i] -match ',\s*[3-6]\s*,') {
                  $lines[$i] = $lines[$i] -replace ',\s*([3-6])\s*,', ', 12,'
                  Write-Host "Modified line $($i + 1)"
                }
              }
              $lines | Set-Content "windows\config.c"
              Write-Host "Applied broader modification to windows/config.c"
            }
          }
          
          # Step 2: Increase the main configuration dialog window height
          Write-Host ""
          Write-Host "Searching for dialog height definitions..."
          
          # Check multiple possible locations
          $dialogFiles = @("windows\windlg.c", "windows\dialog.c", "windows\putty.rc")
          
          foreach ($file in $dialogFiles) {
            if (Test-Path $file) {
              Write-Host "Checking $file..."
              $content = Get-Content $file -Raw
              $original = $content
              
              # Look for dialog height specifications (typically 250-400 range)
              # Pattern: DIALOG x, y, width, height
              if ($content -match 'DIALOG') {
                $content = $content -replace '(DIALOG\s+\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*)([2-4]\d{2})\b', {
                  param($m)
                  $oldH = [int]$m.Groups[2].Value
                  $newH = $oldH + 120
                  "$($m.Groups[1].Value)$newH"
                }
              }
              
              if ($content -ne $original) {
                Set-Content $file $content
                Write-Host "Success: Increased dialog height in $file"
              }
            }
          }
          
          Write-Host ""
          Write-Host "=== Modifications complete ==="
          Write-Host "Changes made:"
          Write-Host "  - Session listbox height: increased from 3-6 to 12 dialog units"
          Write-Host "  - Dialog window height: increased by 120 pixels"
        shell: powershell
      
      - name: Configure build with CMake
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A Win32
        shell: cmd
      
      - name: Build PuTTY
        run: |
          cd build
          cmake --build . --config Release
        shell: cmd
      
      - name: Collect artifacts
        run: |
          mkdir output
          Copy-Item "build\Release\putty.exe" "output\" -ErrorAction Stop
        shell: powershell
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: putty-modified-windows
          path: output/
          retention-days: 30
      
      - name: Create release (optional)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: putty-modified-${{ github.run_number }}
          name: Modified PuTTY Build ${{ github.run_number }}
          body: |
            Modified PuTTY build with increased session list visible height.
            
            Built from latest PuTTY release.
            
            **Modifications:**
            - Increased session list dropdown height for better visibility (no scrolling needed for more sessions)
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
